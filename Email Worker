import { Worker } from "bullmq";
import nodemailer from "nodemailer";
import { redis } from "../config/redis";
import { env } from "../config/env";
import { canSendEmail } from "../services/rateLimiter";

const transporter = nodemailer.createTransport({
  host: "smtp.ethereal.email",
  port: 587,
  auth: {
    user: process.env.ETHEREAL_USER!,
    pass: process.env.ETHEREAL_PASS!,
  },
});

new Worker(
  "email-queue",
  async (job) => {
    const { to, subject, body, sender } = job.data;

    const allowed = await canSendEmail(sender);
    if (!allowed) {
      await job.moveToDelayed(Date.now() + 60 * 60 * 1000);
      return;
    }

    await transporter.sendMail({
      from: sender,
      to,
      subject,
      text: body,
    });

    await new Promise((r) => setTimeout(r, env.MIN_DELAY_MS));
  },
  {
    connection: redis,
    concurrency: 5,
  }
);
